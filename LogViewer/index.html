<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>各種報告書 - KancolleSniffer</title>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/datatables/1.10.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/datatables/1.10.7/css/jquery.dataTables.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link rel="stylesheet" type="text/css" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/i18n/datepicker-ja.min.js"></script>
<style>
body {
    font-family:'Lucida Grande','Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
    line-height: 1.5;
    font-size: 14px;
}
.tab {overflow: hidden; list-style-type: none; margin: 0em 2em 2em 1em; padding: 0em;}
.tab li {background: #eee; padding: 0.3em 2.0em; float: left; margin-right: 2px;}
.tab li.select {background: #ccc;}
.contents {list-style-type: none; margin: 0em; padding: 0em;}
.hide {display: none;}
#loading {
    width: 48px;
    height: 48px;
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    margin-top: -24px;
    margin-left: -24px;
    z-index: 100;
}
</style>

</head>
<body>
<script>
function showLog()
{
    var query = "?from=" + moment().subtract(1, 'months').valueOf();
    if ($('input[name=term]:eq(1)').prop('checked')) {
        from = $('#term_from').datepicker("getDate");
        to = $('#term_to').datepicker("getDate");
        if (from != null)
            query = "?from=" + from.valueOf();
        if (to != null)
            query += "&to=" + (to.valueOf() + 3600 * 24 * 1000);
    }
    var jsons = [
        "海戦・ドロップ報告書.json",
        "海戦・ドロップ報告書.json",
        "遠征報告書.json",
        "開発報告書.json",
        "建造報告書.json",
        "資材ログ.json"
    ];
    $('#loading').show();
    var url = jsons[selectedTable] + query;
    $('#log' + selectedTable).DataTable().ajax.url(url).load();
}

function initTables()
{
    for (var t = 0; t < 6; t++) {
        var opts = {
            destroy: true,
            deferRender: true,
            stateSave: true,
            order: [[0, "desc"]],
            pageLength: 50,
            lengthMenu: [[50, 100, 200, -1],[50, 100, 200, "All"]],
            drawCallback: function () {
                $('#loading').hide();
            }
        };
        if (t == 0) {
            opts.columns = [{data: 0}, {data: 1}, {data: 2}, {data: 3}, {data: 4}, {data: 9}, {data: 10}];
        } else if (t == 1) {
            var entries = [];
            for (i = 0; i < 35; i++) {
                if (i == 9 || i == 10)
                    continue;
                entries.push({data: i})
            }
            opts.columns = entries;
        }
        $('#log' + t).dataTable(opts);
    }
}

const timeFormat = "YYYY-MM-DD HH:mm:ss";
function parseDate(d)
{
    return moment(d, timeFormat);
}

function toString(d)
{
    return d.format(timeFormat);
}

function pickChartData(data, range)
{
    var newdata = [];
    var ticks = [];
    var grid = [];
    var last = moment(data[data.length - 1][0]).valueOf();
    var first, interval, tickInterval;
    const oneDay = 3600 * 24 * 1000;
    switch (range) {
    case 0:
        first = moment(last).subtract(24, 'hours').valueOf();
        interval = 1000;
        tickInterval = 3600 * 1000;
        last -= last % tickInterval;
        break;
    case 1:
        first = moment(last).subtract(7, 'days').valueOf();
        interval = 1000;
        tickInterval = oneDay;
        last -= last % tickInterval + 3600 * 4000;
        break;
    case 2:
        first = moment(last).subtract(1, 'months').valueOf();
        last = moment(last).day(1).valueOf();
        interval = 3600 * 2000;
        tickInterval = oneDay * 7;
        last -= last % oneDay + 3600 * 4000;
        break;
    case 3:
        first = moment(data[0][0]).valueOf();
        last = moment(last).day(1).valueOf();
        interval = 3600 * 6000;
        tickInterval = oneDay * 7;
        last -= last % oneDay + 3600 * 4000;
        break;
    }
    for (var tick = last; tick > first; tick -= tickInterval)
    {
        var str = toString(moment(tick));
        ticks.unshift(str);
        grid.unshift({value: str});
    }
    var last_data;
    for (var i = data.length - 1; i >= 0; i--) {
        var row = data[i];
        var date = parseDate(row[0]).valueOf();
        if (date > first) {
            var v = date - date % interval;
            if (last_data != v) {
                newdata.unshift(row);
                last_data = v;
            }
        } else {
            break;
        }
    }
    return { data: newdata, tick: ticks, grid: grid };
}

var selectedTable = 0;
var selectedRange = 0;

function drawChart(data)
{
    if (data == null) {
        $('#loading').show();
        $.get("./資材ログ.json?time=" + Date.now(), function (data) { drawChart(data);}, "json");
        return;
    }
    picked = pickChartData(data.data, selectedRange);
    var header = ["日付","燃料","弾薬","鋼材","ボーキ","高速建造材","高速修復材","開発資材","改修資材"];
    picked.data.unshift(header);
    var chart = c3.generate({
        bindto: '#chart',
        size: {
            height: 400,
            width: 800
        },
        data: {
            x: '日付',
            xFormat: '%Y-%m-%d %X',
            rows: picked.data,
            axes: {
                燃料: 'y',
                弾薬: 'y',
                鋼材: 'y',
                ボーキ: 'y',
                高速建造材: 'y2',
                高速修復材: 'y2',
                開発資材: 'y2',
                改修資材: 'y2'
            }
        },
        point: {
            show: false
        },
        tooltip: {
            show: $('#tooltip').prop('checked')
        },
        grid: {
            x: {
                lines: picked.grid
            }
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    rotate: 30,
                    format: function (x) { return moment(x).format("MM-DD HH:mm"); },
                    values: picked.tick
                },
                height: 60
            },
            y2: {
                show: true
            }
        },
        onrendered: function () { $('#loading').hide(); }
    });
}

function setSortieStat(data) {
    if (!data) {
        $('#loading').show();
        var from = moment().subtract(1, 'months').valueOf();
        $.get("./海戦・ドロップ報告書.json?time=" + Date.now() + "&from=" + from, function (data) { setSortieStat(data.data);}, "json");
        return;
    }
    var r = {
        day: {stat: {}},
        week: {stat: {}},
        month: {stat: {}}
    };
    var initStat = function () { return {start:"-", S:0, A:0, B:0, C:0, D:0} };
    now = moment();
    r.day.begin = moment(now).hour(5).minute(0);
    if (now.hour() < 5) {
        r.day.begin.subtract(1, 'days');
    }
    r.week.begin = moment(now).day(1).hour(5).minute(0);
    if (now.day() == 0 || now.day() == 1 && now.hour() < 5) {
        r.week.begin.subtract(1, 'weeks');
    }
    r.month.begin = moment(now).date(1).hour(5).minute(0);
    if (now.date() == 1 && now.hours() < 5) {
        r.month.begin.subtract(1, 'months');
    }
    for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var date = moment(row[0]);
        var map = row[1];
        var isBoss = row[3].indexOf("ボス") != -1;
        var isStart = row[3].indexOf("出撃") != -1;
        var res = row[4];
        if (res == "E")
            res = "D";
        for (var term in r) {
            to = r[term];
            if (to.begin.isAfter(date))
                continue;
            for (var b = 0; b < 4; b++) {
                var name = b < 2 ? "合計" : map;
                if (b == 1 || b == 3) {
                    if (!isBoss)
                        continue;
                    name = name + " - ボス";
                }
                var mo = to.stat[name];
                if (!mo) {
                    mo = to.stat[name] = initStat();
                    if (name == "合計")
                        to.stat["合計 - ボス"] = initStat();
                }
                mo[res]++;
                if ((b == 0 || b == 2) && isStart)
                {
                    if (mo.start == "-")
                        mo.start = 0;
                    mo.start++
                }
            }
        }
    }
    for (term in r) {
        var table = [];
        for (map in r[term].stat)
        {
            var e = r[term].stat[map];
            e.map = map;
            table.push(e);
        }
        var dt = $("#sortie_stat_" + term).DataTable();
        dt.clear();
        dt.rows.add(table).draw();
    }
    $('#loading').hide();
}

function initSortieStat()
{
    var terms = ['day', 'week', 'month'];
    for (var i = 0; i < terms.length; i++) {
        $("#sortie_stat_" + terms[i]).dataTable({
            paging: false,
            searching: false,
            ordering: false,
            columns: [
                { data: "map" },
                { data: "start" },
                { data: "S" },
                { data: "A" },
                { data: "B" },
                { data: "C" },
                { data: "D" }
            ]
        });
    }
}

function selectTopTab(i)
{
    if (i < 6) {
        selectedTable = i;
        showLog();
    } else if (i == 6) {
        drawChart();
    } else if (i == 7) {
        setSortieStat();
    }
    if (i < 6)
        $('#term').show();
    else
        $('#term').hide();
    var tab = $('.tab0 li');
    tab.removeClass('select');
    tab.eq(i).addClass('select');
    $('.contents .hide').hide();
    $('.contents .hide').eq(i).show();
}

$(function() {
    $.fn.dataTable.ext.errMode = 'throw';
    $('.tab0 li').click(function() {
        var tab = $('.tab0 li');
        var i = tab.index(this)
        selectTopTab(i);
        sessionStorage.setItem('prevTab', i);
    });
    $('.tab1 li').click(function() {
        var tab = $('.tab1 li');
        var i = tab.index(this);
        selectedRange = i;
        drawChart();
        tab.removeClass('select');
        tab.eq(i).addClass('select');
        sessionStorage.setItem('prevRange', i);
    });
    $('#tooltip').change(function() {
        drawChart();
    });
    $('table').addClass('display compact cell-border');
    initTables();
    initSortieStat();
    var range = sessionStorage.getItem('prevRange');
    selectedRange = range == null ? 0 : +range;
    $('.tab1 li').eq(range).addClass('select');
    $('#term_from').datepicker({
        defaultDate: moment().subtract(1, 'months').toDate()
    });
    $('#term_to').datepicker();
    $('#term_apply').click(showLog);
    var prev = sessionStorage.getItem('prevTab');
    selectTopTab(prev == null ? 0 : +prev);
});
</script>

<div id="loading"><img src="http://kancollesniffer.osdn.jp/ajax-loader.gif" alt="読み込み中..."></div>

<ul class="tab tab0">
<li>ドロップ</li>
<li>海戦</li>
<li>遠征</li>
<li>開発</li>
<li>建造</li>
<li>資材</li>
<li>資材グラフ</li>
<li>出撃統計</li>
</ul>

<form id="term">
<p>
<label><input type="radio" name="term" value="0" checked="checked">直近一か月</label>
<label><input type="radio" name="term" value="1">指定の期間: </label>
<input type="text" id="term_from" style="width: 8em">～<input type="text" id="term_to" style="width: 8em">
<input type="button" id="term_apply" value="適用">
</p>
</form>

<ul class="contents">
<li class="hide">
<table id="log0">
<thead>
<tr><th>日付</th><th>海域</th><th>マス</th><th>ボス</th><th>ランク</th><th>ドロップ艦種</th><th>ドロップ艦娘</th></tr>
</thead>
</table>

<li class="hide">
<table id="log1">
<thead>
<tr><th>日付</th><th>海域</th><th>マス</th><th>ボス</th><th>ランク</th><th>艦隊行動</th><th>味方陣形</th><th>敵陣形</th><th>敵艦隊</th><th>味方艦1</th><th>味方艦1HP</th><th>味方艦2</th><th>味方艦2HP</th><th>味方艦3</th><th>味方艦3HP</th><th>味方艦4</th><th>味方艦4HP</th><th>味方艦5</th><th>味方艦5HP</th><th>味方艦6</th><th>味方艦6HP</th><th>敵艦1</th><th>敵艦1HP</th><th>敵艦2</th><th>敵艦2HP</th><th>敵艦3</th><th>敵艦3HP</th><th>敵艦4</th><th>敵艦4HP</th><th>敵艦5</th><th>敵艦5HP</th><th>敵艦6</th><th>敵艦6HP</th></tr>
</thead>
</table>

<li class="hide">
<table id="log2">
<thead>
<tr><th>日付</th><th>結果</th><th>遠征</th><th>燃料</th><th>弾薬</th><th>鋼材</th><th>ボーキ</th><th>開発資材</th><th>高速修復材</th><th>高速建造材</th></tr>
</thead>
</table>

<li class="hide">
<table id="log3">
<thead>
<tr><th>日付</th><th>開発装備</th><th>種別</th><th>燃料</th><th>弾薬</th><th>鋼材</th><th>ボーキ</th><th>秘書艦</th><th>司令部Lv</th></tr>
</thead>
</table>

<li class="hide">
<table id="log4">
<thead>
<tr><th>日付</th><th>種類</th><th>名前</th><th>艦種</th><th>燃料</th><th>弾薬</th><th>鋼材</th><th>ボーキ</th><th>開発資材</th><th>空きドック</th><th>秘書艦</th><th>司令部Lv</th></tr>
</thead>
</table>

<li class="hide">
<table id="log5">
<thead>
<tr><th>日付</th><th>燃料</th><th>弾薬</th><th>鋼材</th><th>ボーキ</th><th>高速建造材</th><th>高速修復材</th><th>開発資材</th><th>改修資材</th></tr>
</thead>
</table>

<li class="hide">
<ul class="tab tab1" style="float: left">
<li>一日</li>
<li>一週間</li>
<li>一か月</li>
<li>すべて</li>
</ul>
<label><input type="checkbox" id="tooltip" value="">ツールチップ</label>
<div id="chart" style="clear: both; width: 800px; margin: 1em;"></div>

<li class="hide">
<h3>今日</h3>
<table id="sortie_stat_day">
<thead>
<tr><th>マップ</th><th>出撃</th><th>S</th><th>A</th><th>B</th><th>C</th><th>D以下</th></tr>
</thead>
</table>

<h3>今週</h3>
<table id="sortie_stat_week">
<thead>
<tr><th>マップ</th><th>出撃</th><th>S</th><th>A</th><th>B</th><th>C</th><th>D以下</th></tr>
</table>

<h3>今月</h3>
<table id="sortie_stat_month">
<thead>
<tr><th>マップ</th><th>出撃</th><th>S</th><th>A</th><th>B</th><th>C</th><th>D以下</th></tr>
</table>
</ul>
</body>
</html>
